version: '3'
services:
  postgres:
    image: postgres:12.1-alpine
    ports:
      - "8001:5432"
    restart: always
    volumes:
      - ./services/postgres/:/docker-entrypoint-initdb.d/
      - pgdata:/var/lib/postgresql/data
    env_file:
      - ./config/shared_database.env
      - ./config/airflow_database.env

  jnb:
    build: kbase/jupyter/
    ports:
      - "10000:8888"
    restart: always
    volumes:
      - ./kbase/jupyter/notebooks/:/home/jovyan/work
    env_file:
      - ./config/shared_database.env
      - ./config/jupyter.env
    entrypoint: sh -c 'start-notebook.sh --NotebookApp.token=$$JUPYTER_PASSWORD'

  sql_app:
    build: kbase/sql_app/
    ports:
      - "8087:80"
    restart: always
    depends_on:
      - postgres
    env_file:
      - ./config/shared_database.env

  vue_app:
    build: kbase/vue_app/
    ports:
      - "8088:8080"
    restart: always
    depends_on:
      - postgres
    volumes:
      - ./kbase/vue_app/vue_app/src/:/app/src
      - ./kbase/vue_app/vue_app/public/:/app/public

  airflow:
    image: puckel/docker-airflow:1.10.7
    ports:
      - "8080:8080"
    restart: always
    depends_on:
      - postgres
    env_file:
      - ./config/airflow_container.env
      - ./config/shared_database.env
    volumes:
      - ./config/airflow_requirements.txt:/requirements.txt
      - ./kbase/dags/:/usr/local/airflow/dags
      # - ./plugins:/usr/local/airflow/plugins
    logging:
        options:
            max-size: 10m
            max-file: "3"
    command: webserver
    healthcheck:
        test: ["CMD-SHELL", "[ -f /usr/local/airflow/airflow-webserver.pid ]"]
        interval: 30s
        timeout: 30s
        retries: 3

#  elastic:
#    image: elasticsearch:7.6.0
#    ports:
#      - "9200:9200"
#      - "9300:9300"
#    restart: always
#    depends_on:
#      - postgres
#    env_file:
#      - ./config/elasticsearch.env
#
#  kibana:
#    image: kibana:7.6.0
#    ports:
#      - "5601:5601"
#    restart: always
#    depends_on:
#      - elastic

volumes:
  pgdata: